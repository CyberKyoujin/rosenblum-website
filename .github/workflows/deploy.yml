name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ====================================================
  # JOB 1: BACKEND TESTS
  # ====================================================
  backend-tests:
    name: üêç Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: rosenblum_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Backend Dependencies
        run: |
          cd backend/backend
          pip install -r requirements.txt
          pip install pytest pytest-django

      - name: Run Backend Tests
        env:
          DATABASE_URL: postgres://test_user:test_password@localhost:5432/rosenblum_test
          SECRET_KEY: "test_secret_key_ci"
          DEBUG: "True"
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          GEMINI_API_KEY: "test_key"
          DEEPL_AUTH_KEY: "test_key"
          GOOGLE_PLACES_API_KEY: "test_key"
          GOOGLE_PLACE_ID: "test_place_id"
          GS_BUCKET_NAME: ""
          FRONTEND_URL: "http://localhost:3000"
        run: |
          cd backend/backend
          pytest -q
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # ====================================================
  # JOB 2: FRONTEND UNIT TESTS
  # ====================================================
  frontend-tests:
    name: ‚öõÔ∏è Frontend Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install & Test Frontend (User)
        run: |
          cd frontend/frontend
          npm ci
          npm run test -- --run

      - name: Install & Test Frontend (Admin)
        run: |
          cd frontend-admin/frontend-admin
          npm ci
          npm run test -- --run
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # ====================================================
  # JOB 3: E2E MOCKED TESTS
  # ====================================================
  e2e-mocked:
    name: üé≠ E2E Tests (Mocked)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install User Frontend
        run: |
          cd frontend/frontend
          npm ci

      - name: Install Playwright Browsers
        run: |
          cd frontend/frontend
          npx playwright install --with-deps chromium

      - name: Run E2E Tests (User Frontend)
        run: |
          cd frontend/frontend
          npx playwright test --project=chromium --reporter=list

      - name: Install Admin Frontend
        run: |
          cd frontend-admin/frontend-admin
          npm ci

      - name: Install Playwright Browsers (Admin)
        run: |
          cd frontend-admin/frontend-admin
          npx playwright install --with-deps chromium

      - name: Run E2E Tests (Admin Frontend)
        run: |
          cd frontend-admin/frontend-admin
          npx playwright test --project=chromium --reporter=list

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # ====================================================
  # JOB 4: E2E INTEGRATION TESTS (Real Backend)
  # ====================================================
  e2e-integration:
    name: üîó E2E Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres-e2e:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: rosenblum_e2e
          POSTGRES_USER: e2e_user
          POSTGRES_PASSWORD: e2e_password
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U e2e_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Backend Dependencies
        run: |
          cd backend/backend
          pip install -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install User Frontend & Playwright
        run: |
          cd frontend/frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: Install Admin Frontend & Playwright
        run: |
          cd frontend-admin/frontend-admin
          npm ci
          npx playwright install --with-deps chromium

      - name: Start Backend
        env:
          DATABASE_URL: postgres://e2e_user:e2e_password@localhost:5433/rosenblum_e2e
          SECRET_KEY: "test_secret_key_ci_e2e"
          DEBUG: "True"
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          GEMINI_API_KEY: "test_key"
          DEEPL_AUTH_KEY: "test_key"
          GOOGLE_PLACES_API_KEY: "test_key"
          GOOGLE_PLACE_ID: "test_place_id"
          GS_BUCKET_NAME: ""
          FRONTEND_URL: "http://localhost:3000"
          CORS_ALLOWED_ORIGINS: "http://localhost:3000"
          DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
        run: |
          cd backend/backend
          python manage.py migrate --noinput
          python init_superuser.py
          python manage.py runserver 0.0.0.0:8000 &
          sleep 10
          curl -f http://localhost:8000/api/ || echo "Backend health check"

      - name: Run Integration E2E Tests (User Frontend)
        run: |
          cd frontend/frontend
          npx playwright test --config=playwright.integration.config.ts

      - name: Run Integration E2E Tests (Admin Frontend)
        run: |
          cd frontend-admin/frontend-admin
          npx playwright test --config=playwright.integration.config.ts

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # ====================================================
  # DEPLOY
  # ====================================================
  deploy:
    name: üöÄ Deploy to Hetzner
    needs: [backend-tests, frontend-tests, e2e-mocked, e2e-integration]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            cd /app

            # 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git reset --hard
            git pull origin master

            # 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø .ENV –§–ê–ô–õ–ê
            echo "DEBUG=${{ secrets.DEBUG }}" > .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env
            echo "TIME_ZONE=${{ secrets.TIME_ZONE }}" >> .env
            echo "LANGUAGE_CODE=${{ secrets.LANGUAGE_CODE }}" >> .env

            # Database
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env

            # Email Settings
            echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> .env
            echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> .env
            echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> .env
            echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> .env
            echo "EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}" >> .env
            echo "EMAIL_USE_SSL=${{ secrets.EMAIL_USE_SSL }}" >> .env

            # Superuser Creation
            echo "DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}" >> .env
            echo "DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}" >> .env
            echo "DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}" >> .env

            # Google Services & APIs
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "DEEPL_AUTH_KEY=${{ secrets.DEEPL_AUTH_KEY }}" >> .env
            echo "GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}" >> .env
            echo "GOOGLE_PLACE_ID=${{ secrets.GOOGLE_PLACE_ID }}" >> .env

            # Google Auth (Social)
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_KEY=${{ secrets.SOCIAL_AUTH_GOOGLE_OAUTH2_KEY }}" >> .env
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET=${{ secrets.SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET }}" >> .env

            # Google Cloud Storage
            echo "GS_BUCKET_NAME=${{ secrets.GS_BUCKET_NAME }}" >> .env
            echo "GOOGLE_SERVICE_ACCOUNT_FILE=service-account.json" >> .env

            # Frontend URL
            echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env

            # 4. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–ª—é—á–∞ Google (JSON) –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
            echo '${{ secrets.GOOGLE_CREDENTIALS }}' > backend/backend/service-account.json

            # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker compose down
            docker compose up -d --build --remove-orphans

            # 6. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            sleep 15
            docker compose exec -T backend python manage.py migrate --noinput
            docker compose exec -T backend python manage.py collectstatic --noinput

            # 7. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            docker system prune -f
