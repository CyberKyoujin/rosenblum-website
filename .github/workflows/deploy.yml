name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ====================================================
  # STAGE 1: TESTING
  # ====================================================
  tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: rosenblum_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Backend Tests ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Backend Dependencies
        run: |
          cd backend/backend
          pip install -r requirements.txt
          pip install pytest pytest-django

      - name: Run Backend Tests
        env:
          DATABASE_URL: postgres://test_user:test_password@localhost:5432/rosenblum_test
          SECRET_KEY: "test_secret_key_ci"
          DEBUG: "True"
        run: |
          cd backend/backend
          pytest

      # --- Frontend Tests ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install & Test Frontend (User)
        run: |
          cd frontend/frontend
          npm ci
          npm run test -- --run

      - name: Install & Test Frontend (Admin)
        run: |
          cd frontend-admin/frontend-admin
          npm ci
          npm run test -- --run

  

  # ====================================================
  # –≠–¢–ê–ü 2: –î–ï–ü–õ–û–ô –ù–ê HETZNER
  # ====================================================
  deploy:
    name: üöÄ Deploy to Hetzner
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            cd /app 

            # 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git reset --hard
            git pull origin main

            # 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø .ENV –§–ê–ô–õ–ê (–¢–≤–æ–π –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)
            # –ú—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª .env —Å –Ω—É–ª—è
            echo "DEBUG=${{ secrets.DEBUG }}" > .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env
            echo "TIME_ZONE=${{ secrets.TIME_ZONE }}" >> .env
            echo "LANGUAGE_CODE=${{ secrets.LANGUAGE_CODE }}" >> .env
            
            # Database
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
            
            # Email Settings
            echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> .env
            echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> .env
            echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> .env
            echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> .env
            echo "EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}" >> .env
            echo "EMAIL_USE_SSL=${{ secrets.EMAIL_USE_SSL }}" >> .env
            
            # Superuser Creation (–¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ init_superuser.py)
            echo "DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}" >> .env
            echo "DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}" >> .env
            echo "DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}" >> .env
            
            # Google Services & APIs
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "DEEPL_AUTH_KEY=${{ secrets.DEEPL_AUTH_KEY }}" >> .env
            echo "GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}" >> .env
            echo "GOOGLE_PLACE_ID=${{ secrets.GOOGLE_PLACE_ID }}" >> .env
            
            # Google Auth (Social)
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_KEY=${{ secrets.SOCIAL_AUTH_GOOGLE_OAUTH2_KEY }}" >> .env
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET=${{ secrets.SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET }}" >> .env
            
            # Google Cloud Storage
            echo "GS_BUCKET_NAME=${{ secrets.GS_BUCKET_NAME }}" >> .env
            # –í–∞–∂–Ω–æ: –∏–º—è —Ñ–∞–π–ª–∞ –º—ã –∑–∞–¥–∞–µ–º –∂–µ—Å—Ç–∫–æ, —Ç–∞–∫ –∫–∞–∫ —Å–∞–º–∏ —Å–æ–∑–¥–∞–¥–∏–º –µ–≥–æ –Ω–∏–∂–µ
            echo "GOOGLE_SERVICE_ACCOUNT_FILE=service-account.json" >> .env
            
            # Frontend URL (–¥–ª—è CORS –∏ —Å—Å—ã–ª–æ–∫)
            echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env

            # 4. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–ª—é—á–∞ Google (JSON) –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ JSON
            echo '${{ secrets.GOOGLE_CREDENTIALS }}' > backend/backend/service-account.json

            # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build --remove-orphans

            # 6. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            docker system prune -f